{
    "id": "job_control",
    "name": "Job Control System",
    "description": "Controls jobs and handles job progress (Increases a persistent counter for each completed product). Stops a job after a specified amount of products was created.",
    "version": "1.0.0",
    "specVersion": "0.8",
    "events": [
      {
        "name": "product-complete",
        "source": "job",
        "type": "product-complete"
      },
      {
        "name": "job-done",
        "source": "job",
        "type": "job-done",
        "kind": "produced"
      }
    ],
    "functions": [
      {
        "name": "increment-products-completed",
        "operation": ".productsCompleted += 1 | .productsCompleted",
        "type": "expression"
      }
    ],
    "start": "starting",
    "states": [
      {
        "name": "starting",
        "type": "inject",
        "data": {
          "productsCompleted": 0,
          "totalProducts": 4
        },
        "transition": "running"
      },
      {
        "name": "running",
        "type": "event",
        "onEvents": [
          {
            "actions": [],
            "eventRefs": [
              "product-complete"
            ],
            "eventDataFilter": {}
          }
        ],
        "transition": "running-increment"
      },
      {
        "name": "running-increment",
        "type": "operation",
        "actions": [
          {
            "name": "action-increment",
            "actionDataFilter": {
              "toStateData": "${ .productsCompleted }"
            },
            "functionRef": {
              "refName": "increment-products-completed"
            }
          }
        ],
        "transition": "running-switch"
      },
      {
        "name": "running-switch",
        "type": "switch",
        "dataConditions": [
          {
            "name": "case-done",
            "transition": "jobDone",
            "condition": "${ .productsCompleted >= .totalProducts }"
          }
        ],
        "defaultCondition": {
          "transition": "running"
        }
      },
      {
        "name": "jobDone",
        "type": "inject",
        "data": {
          "jobDone": true
        },
        "end": {
          "terminate": true,
          "produceEvents": [
            {
              "eventRef": "job-done"
            }
          ]
        }
      }
    ]
  }